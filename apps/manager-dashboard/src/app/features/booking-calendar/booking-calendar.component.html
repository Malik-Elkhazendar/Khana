<a class="skip-link dashboard-skip-link" href="#booking-calendar-main">{{
  text('BOOKING_CALENDAR.PAGE.SKIP_LINK', 'Skip to calendar')
}}</a>
<main
  class="calendar dashboard-page"
  id="booking-calendar-main"
  role="main"
  [attr.aria-busy]="loading() ? 'true' : null"
  [attr.aria-describedby]="error() ? errorDescriptionId : null"
>
  <!-- Header -->
  <header class="calendar__header dashboard-page__header">
    <div class="calendar__title-group dashboard-page__title-group">
      <h1 class="dashboard-page__title">
        {{ text('BOOKING_CALENDAR.PAGE.TITLE', 'Calendar') }}
      </h1>
      <p class="dashboard-page__subtitle">{{ weekRange() }}</p>
    </div>

    <div class="calendar__nav dashboard-page__actions">
      <button
        type="button"
        class="calendar__nav-btn"
        (click)="previousWeek()"
        [attr.aria-label]="
          text('BOOKING_CALENDAR.NAV.PREVIOUS_WEEK', 'Previous week')
        "
        [disabled]="!canNavigate()"
        [attr.aria-disabled]="!canNavigate()"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
            clip-rule="evenodd"
          />
        </svg>
      </button>

      <button
        type="button"
        class="calendar__today-btn"
        (click)="goToToday()"
        [disabled]="!canNavigate()"
        [attr.aria-disabled]="!canNavigate()"
      >
        {{ text('BOOKING_CALENDAR.NAV.TODAY', 'Today') }}
      </button>

      <button
        type="button"
        class="calendar__nav-btn"
        (click)="nextWeek()"
        [attr.aria-label]="text('BOOKING_CALENDAR.NAV.NEXT_WEEK', 'Next week')"
        [disabled]="!canNavigate()"
        [attr.aria-disabled]="!canNavigate()"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path
            fill-rule="evenodd"
            d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
            clip-rule="evenodd"
          />
        </svg>
      </button>
    </div>
  </header>

  <!-- Loading State -->
  @if (loading()) {
  <div
    class="calendar__loading"
    role="status"
    aria-live="polite"
    aria-atomic="true"
  >
    <div class="calendar__spinner"></div>
    <span>{{
      text('BOOKING_CALENDAR.STATE.LOADING', 'Loading bookings...')
    }}</span>
  </div>
  }

  <!-- Error State -->
  @if (error(); as err) {
  <div
    class="calendar__error"
    role="alert"
    aria-live="assertive"
    [attr.id]="errorDescriptionId"
  >
    <div class="calendar__error-content">
      <p class="calendar__error-message">{{ err.message }}</p>
      @if (errorCategoryLabel()) {
      <p class="calendar__error-meta">{{ errorCategoryLabel() }}</p>
      } @if (autoRetryEligible()) {
      <p class="calendar__error-meta">
        {{
          text(
            'BOOKING_CALENDAR.ERRORS.AUTO_RETRYING',
            'Auto-retrying with backoff.'
          )
        }}
      </p>
      } @if (retryScheduledAt()) {
      <p class="calendar__error-meta">
        {{
          text(
            'BOOKING_CALENDAR.ERRORS.NEXT_RETRY_AT',
            'Next retry at {{time
        }}', { time: formatLastUpdated(retryScheduledAt()) } ) }}
      </p>
      } @if (lastSuccessfulAt()) {
      <p class="calendar__error-meta">
        {{
          text(
            'BOOKING_CALENDAR.ERRORS.SHOWING_LAST_UPDATED',
            'Showing last updated {{time
        }}', { time: formatLastUpdated(lastSuccessfulAt()) } ) }}
      </p>
      }
    </div>
    <div class="calendar__error-actions">
      @for (option of errorRecoveryOptions(); track option.action) {
      <div class="calendar__error-option">
        <button
          type="button"
          class="calendar__retry-btn"
          (click)="handleErrorRecovery(option.action)"
          [attr.aria-describedby]="'calendar-error-option-' + option.action"
        >
          {{ option.label }}
        </button>
        <span
          class="calendar__error-option-meta"
          [attr.id]="'calendar-error-option-' + option.action"
        >
          {{ option.description }}
        </span>
      </div>
      }
    </div>
  </div>
  }

  <!-- Mobile Day View -->
  @if (showContent()) {
  <div class="calendar__day-view">
    <!-- Day Strip -->
    <div
      class="calendar__day-strip"
      role="tablist"
      [attr.aria-label]="text('BOOKING_CALENDAR.ARIA.SELECT_DAY', 'Select day')"
    >
      @for (day of weekDays(); track trackByDay($index, day)) {
      <button
        type="button"
        class="calendar__day-pill"
        [class.calendar__day-pill--active]="isSelectedDay(day)"
        [class.calendar__day-pill--today]="isToday(day)"
        role="tab"
        [attr.aria-selected]="isSelectedDay(day)"
        (click)="selectDay(day)"
      >
        <span class="calendar__day-pill-name">{{ dayName(day) }}</span>
        <span class="calendar__day-pill-number">{{
          formatDayNumber(day)
        }}</span>
      </button>
      }
    </div>

    <!-- Day Timeline -->
    @if (selectedDayBookings().length > 0) {
    <div
      class="calendar__timeline"
      role="list"
      [attr.aria-label]="
        text(
          'BOOKING_CALENDAR.ARIA.BOOKINGS_FOR_SELECTED_DAY',
          'Bookings for selected day'
        )
      "
    >
      @for (segment of selectedDayBookings(); track trackByBooking($index,
      segment)) { @let booking = segment.booking;
      <button
        type="button"
        class="calendar__timeline-card {{ getStatusClass(booking.status) }}"
        [class.calendar__timeline-card--hold]="isHoldActive(booking)"
        role="listitem"
        [attr.aria-label]="timelineBookingAriaLabel(booking)"
        (click)="openBooking(booking, $event)"
      >
        <div class="calendar__timeline-time">
          {{ formatTime(booking.startTime) }} â€“
          {{ formatTime(booking.endTime) }}
        </div>
        <div class="calendar__timeline-details">
          <span class="calendar__timeline-name">{{
            booking.customerName
          }}</span>
          <span class="calendar__timeline-meta">
            {{ booking.facility.name }}
            <app-ui-status-badge
              [tone]="statusTone(booking.status)"
              [label]="statusLabel(booking.status)"
            ></app-ui-status-badge>
          </span>
        </div>
        @if (isHoldActive(booking)) {
        <span class="calendar__timeline-hold">{{
          text('BOOKING_CALENDAR.ACTION_SHEET.HOLD', 'Hold')
        }}</span>
        }
      </button>
      }
    </div>
    } @else if (!loading() && !error()) {
    <div class="calendar__day-empty" role="status">
      <p>
        {{
        text('BOOKING_CALENDAR.STATE.NO_BOOKINGS_FOR_DAY', 'No bookings for {{day
        }}', { day: selectedDayLabel() }) }}
      </p>
    </div>
    }
  </div>
  }

  <!-- Empty State (desktop) -->
  @if (showEmptyState()) {
  <div class="empty-state calendar__empty calendar__grid-view" role="status">
    <p>
      {{
        text(
          'BOOKING_CALENDAR.STATE.NO_BOOKINGS_THIS_WEEK',
          'No bookings found for this week.'
        )
      }}
    </p>
  </div>
  }

  <!-- Calendar Grid (desktop) -->
  @if (showGrid()) {
  <div
    class="calendar__grid calendar__grid-view"
    role="grid"
    [attr.aria-label]="
      text('BOOKING_CALENDAR.ARIA.WEEKLY_GRID', 'Weekly booking calendar')
    "
    [attr.aria-rowcount]="hours.length"
    [attr.aria-colcount]="weekDays().length"
  >
    <!-- Header Row -->
    <div class="calendar__corner"></div>
    @for (day of weekDays(); track trackByDay($index, day)) {
    <div
      class="calendar__day-header"
      [class.calendar__day-header--today]="isToday(day)"
      role="columnheader"
    >
      <span class="calendar__day-name">{{ dayName(day) }}</span>
      <span class="calendar__day-number">{{ formatDayNumber(day) }}</span>
    </div>
    }

    <!-- Time Rows -->
    @for (hour of hours; track trackByHour($index, hour); let hourIndex =
    $index) {
    <!-- Time Label -->
    <div class="calendar__time-label" role="rowheader">
      {{ formatHour(hour) }}
    </div>

    <!-- Day Slots -->
    @for (day of weekDays(); track trackByDay($index, day); let dayIndex =
    $index) { @let slotBookings = getBookingsForSlot(day, hour);
    <div
      class="calendar__slot"
      [class.calendar__slot--today]="isToday(day)"
      [attr.tabindex]="slotTabIndex(dayIndex, hourIndex)"
      [attr.aria-label]="slotAriaLabel(day, hour, slotBookings.length)"
      role="gridcell"
      (focus)="onSlotFocus(dayIndex, hourIndex)"
      (keydown)="onSlotKeydown($event, dayIndex, hourIndex, slotBookings)"
      #slotCell
    >
      @for (segment of slotBookings; track trackByBooking($index, segment)) {
      @let booking = segment.booking; @let layout = getBookingLayout(segment);
      <button
        type="button"
        class="calendar__booking {{ getStatusClass(booking.status) }}"
        [class.calendar__booking--hold]="isHoldActive(booking)"
        [ngStyle]="getBookingStyle(segment, layout.column, layout.columns)"
        [attr.aria-label]="gridBookingAriaLabel(booking)"
        [attr.title]="
          isHoldActive(booking) ? holdUntilTitle(booking.holdUntil) : null
        "
        (click)="openBooking(booking, $event)"
      >
        <span class="calendar__booking-name">{{ booking.customerName }}</span>
        <span class="calendar__booking-facility">{{
          booking.facility.name
        }}</span>
        @if (isHoldActive(booking)) {
        <span class="calendar__booking-hold">{{
          text('BOOKING_CALENDAR.ACTION_SHEET.HOLD', 'Hold')
        }}</span>
        }
      </button>
      }
    </div>
    } }
  </div>
  }
</main>

@if (selectedBookingLive(); as booking) {
<button
  type="button"
  class="sheet-backdrop"
  (click)="closePanel()"
  [attr.aria-label]="
    text('BOOKING_CALENDAR.ACTION_SHEET.CLOSE_ACTIONS', 'Close booking actions')
  "
  tabindex="-1"
></button>

<section
  class="action-sheet"
  role="dialog"
  [attr.aria-modal]="actionDialog() !== null ? 'false' : 'true'"
  aria-labelledby="booking-actions-title"
  [attr.aria-hidden]="actionDialog() !== null ? 'true' : null"
  (keydown)="onPanelKeydown($event)"
  tabindex="-1"
  #actionPanel
>
  <header class="action-sheet__header">
    <div>
      <h3 id="booking-actions-title">
        {{ text('BOOKING_CALENDAR.ACTION_SHEET.TITLE', 'Booking Actions') }}
      </h3>
      <p class="action-sheet__meta">
        {{ booking.customerName }} - {{ booking.facility.name }}
      </p>
    </div>
    <button
      #closeButton
      type="button"
      class="action-sheet__close"
      (click)="closePanel()"
    >
      {{ text('BOOKING_CALENDAR.ACTION_SHEET.CLOSE', 'Close') }}
    </button>
  </header>

  <div class="action-sheet__body">
    <div class="action-sheet__row">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.DATE', 'Date')
      }}</span>
      <span class="value">{{ formatDate(booking.startTime) }}</span>
    </div>
    <div class="action-sheet__row">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.TIME', 'Time')
      }}</span>
      <span class="value"
        >{{ formatTime(booking.startTime) }} -
        {{ formatTime(booking.endTime) }}</span
      >
    </div>
    <div class="action-sheet__row">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.CUSTOMER_PHONE', 'Customer Phone')
      }}</span>
      <a class="value link" [href]="'tel:' + booking.customerPhone">
        {{ booking.customerPhone }}
      </a>
    </div>
    <div class="action-sheet__row">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.STATUS', 'Status')
      }}</span>
      <span class="value">
        <app-ui-status-badge
          [tone]="statusTone(booking.status)"
          [label]="statusLabel(booking.status)"
        ></app-ui-status-badge>
      </span>
    </div>
    <div class="action-sheet__row">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.PAYMENT', 'Payment')
      }}</span>
      <span class="value">
        <app-ui-status-badge
          [tone]="paymentTone(booking.paymentStatus)"
          [label]="paymentLabel(booking.paymentStatus)"
        ></app-ui-status-badge>
      </span>
    </div>
    @if (booking.status === BookingStatus.PENDING && booking.holdUntil) {
    <div class="action-sheet__row action-sheet__row--hold">
      <span class="label">{{
        text('BOOKING_CALENDAR.ACTION_SHEET.HOLD', 'Hold')
      }}</span>
      <span class="value">
        <app-hold-timer
          [holdUntil]="booking.holdUntil"
          [prefix]="text('BOOKING_CALENDAR.HOLD_TIMER.PREFIX', 'Expires in')"
          [expiredLabel]="
            text('BOOKING_CALENDAR.HOLD_TIMER.EXPIRED', 'Expired')
          "
          [emptyLabel]="
            text('BOOKING_CALENDAR.HOLD_TIMER.UNAVAILABLE', 'Unavailable')
          "
        ></app-hold-timer>
        <span class="hold-time">{{ formatTime(booking.holdUntil) }}</span>
      </span>
    </div>
    }
  </div>

  <div class="action-sheet__actions">
    <button
      type="button"
      class="btn primary"
      (click)="openConfirmDialog()"
      [disabled]="!dialogAvailable()"
    >
      {{ text('BOOKING_CALENDAR.ACTIONS.CONFIRM', 'Confirm') }}
    </button>
    <button
      type="button"
      class="btn secondary"
      (click)="openPayDialog()"
      [disabled]="!dialogAvailable()"
    >
      {{ text('BOOKING_CALENDAR.ACTIONS.MARK_PAID', 'Mark Paid') }}
    </button>
    <button
      type="button"
      class="btn danger"
      (click)="openCancelDialog()"
      [disabled]="
        !dialogAvailable() ||
        booking.paymentStatus === PaymentStatus.PAID ||
        booking.paymentStatus === PaymentStatus.PARTIALLY_PAID
      "
    >
      {{ text('BOOKING_CALENDAR.ACTIONS.CANCEL', 'Cancel') }}
    </button>
    @if ( booking.paymentStatus === PaymentStatus.PAID || booking.paymentStatus
    === PaymentStatus.PARTIALLY_PAID ) {
    <p class="action-sheet__note">
      {{
        text(
          'BOOKING_CALENDAR.ACTIONS.PAID_BOOKING_NOTE',
          'Paid booking - cancellation will require refund once payment gateway is integrated.'
        )
      }}
    </p>
    }
  </div>
</section>
} @if (actionDialog(); as dialog) { @let copy = dialogCopy();
<app-confirmation-dialog
  [title]="
    copy?.title ??
    text('BOOKING_CALENDAR.DIALOG.FALLBACK_TITLE', 'Confirm action')
  "
  [message]="copy?.message ?? ''"
  [confirmLabel]="
    copy?.confirmLabel ??
    text('BOOKING_CALENDAR.DIALOG.FALLBACK_CONFIRM', 'Confirm')
  "
  [confirmTone]="copy?.confirmTone ?? 'primary'"
  [confirmDisabled]="dialog.type === 'cancel' && !cancelReasonValid()"
  [busy]="actionInProgress()"
  (confirmed)="submitDialogAction()"
  (dismissed)="closeDialog()"
>
  @if (dialog.type === 'cancel') {
  <app-cancellation-form
    [reason]="cancelReason()"
    [minLength]="cancelReasonMinLength"
    (reasonChange)="cancelReason.set($event)"
  ></app-cancellation-form>
  }
</app-confirmation-dialog>
} @if (toast(); as notice) {
<app-ui-toast
  [message]="notice.message"
  [tone]="notice.tone"
  mode="fixed-bottom"
></app-ui-toast>
}
