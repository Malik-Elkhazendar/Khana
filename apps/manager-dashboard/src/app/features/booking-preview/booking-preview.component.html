<a class="skip-link dashboard-skip-link" href="#booking-preview-main">{{
  text('BOOKING_PREVIEW.PAGE.SKIP_LINK', 'Skip to booking preview')
}}</a>
<main
  class="booking-preview dashboard-page"
  id="booking-preview-main"
  role="main"
>
  <header class="dashboard-page__header">
    <div class="dashboard-page__title-group">
      <h1 class="dashboard-page__title">
        {{ text('BOOKING_PREVIEW.PAGE.TITLE', 'Booking Preview') }}
      </h1>
      <p class="subtitle dashboard-page__subtitle">
        {{
          text(
            'BOOKING_PREVIEW.PAGE.SUBTITLE',
            'Check availability and pricing before creating a booking'
          )
        }}
      </p>
    </div>
  </header>

  @if (toast(); as toast) {
  <app-ui-toast
    [message]="toast.message"
    [tone]="toast.tone"
    mode="inline"
  ></app-ui-toast>
  } @if (!isOnline()) {
  <div class="connection-banner" role="status" aria-live="polite">
    {{ connectionMessage() }}
  </div>
  }

  <!-- Booking Form -->
  <form
    class="booking-form dashboard-card"
    (ngSubmit)="onSubmit()"
    [attr.aria-busy]="loading() || facilitiesLoading()"
    [attr.aria-describedby]="
      error()
        ? 'booking-preview-error'
        : validationErrors().length > 0
        ? 'form-errors'
        : null
    "
  >
    <!-- Form Validation Errors -->
    @if (validationErrors().length > 0 && !error()) {
    <div
      class="form-validation-errors"
      id="form-errors"
      role="alert"
      aria-live="polite"
    >
      <ul>
        @for (err of validationErrors(); track err) {
        <li>{{ err }}</li>
        }
      </ul>
    </div>
    }

    <!-- Facility Selection -->
    <div class="form-group">
      <label for="facility">{{
        text('BOOKING_PREVIEW.FORM.FACILITY_LABEL', 'Facility')
      }}</label>
      <select
        id="facility"
        [ngModel]="selectedFacilityId()"
        (ngModelChange)="selectedFacilityId.set($event)"
        name="facility"
        required
        autocomplete="organization"
        dir="auto"
        [attr.lang]="inputLang()"
        [disabled]="loading() || facilitiesLoading()"
        [attr.aria-invalid]="
          selectedFacilityId().trim().length === 0 && !facilitiesLoading()
        "
      >
        @for (facility of facilities(); track facility.id) {
        <option [value]="facility.id" dir="auto" [attr.lang]="inputLang()">
          {{ facilityOptionLabel(facility) }}
        </option>
        }
      </select>
      @if (selectedFacilityRateLabel()) {
      <p class="facility-rate-hint" dir="auto" [attr.lang]="inputLang()">
        {{ selectedFacilityRateLabel() }}
      </p>
      }
    </div>

    <!-- Date Selection -->
    <div class="form-group">
      <label for="date">{{
        text('BOOKING_PREVIEW.FORM.DATE_LABEL', 'Date')
      }}</label>
      <input
        type="date"
        id="date"
        [ngModel]="selectedDate()"
        (ngModelChange)="selectedDate.set($event)"
        name="date"
        required
        [attr.lang]="inputLang()"
        autocomplete="off"
        [disabled]="loading() || facilitiesLoading()"
        [attr.aria-invalid]="selectedDate().trim().length === 0"
      />
    </div>

    <!-- Time Selection -->
    <div class="form-row">
      <div class="form-group">
        <label for="startTime">{{
          text('BOOKING_PREVIEW.FORM.START_TIME_LABEL', 'Start Time')
        }}</label>
        <input
          type="time"
          id="startTime"
          [ngModel]="startTime()"
          (ngModelChange)="startTime.set($event)"
          name="startTime"
          required
          [attr.lang]="inputLang()"
          autocomplete="off"
          [disabled]="loading() || facilitiesLoading()"
          [attr.aria-invalid]="
            startTime().trim().length === 0 ||
            (endTime().trim().length > 0 && !isValidTimeRange())
          "
        />
      </div>
      <div class="form-group">
        <label for="endTime">{{
          text('BOOKING_PREVIEW.FORM.END_TIME_LABEL', 'End Time')
        }}</label>
        <input
          type="time"
          id="endTime"
          [ngModel]="endTime()"
          (ngModelChange)="endTime.set($event)"
          name="endTime"
          required
          [attr.lang]="inputLang()"
          autocomplete="off"
          [disabled]="loading() || facilitiesLoading()"
          [attr.aria-invalid]="
            endTime().trim().length === 0 ||
            (startTime().trim().length > 0 && !isValidTimeRange())
          "
        />
      </div>
    </div>
    <p class="timezone-hint">
      {{
        text(
          'BOOKING_PREVIEW.FORM.TIMEZONE_HINT',
          'Times shown in {{timezone
      }}', { timezone: timezoneLabel } ) }}
    </p>

    <!-- Promo Code -->
    <div class="form-group">
      <label for="promoCode">{{
        text('BOOKING_PREVIEW.FORM.PROMO_LABEL', 'Promo Code (Optional)')
      }}</label>
      <input
        type="text"
        id="promoCode"
        [ngModel]="promoCode()"
        (ngModelChange)="promoCode.set($event)"
        name="promoCode"
        [attr.placeholder]="
          text('BOOKING_PREVIEW.FORM.PROMO_PLACEHOLDER', 'Enter promo code')
        "
        autocomplete="off"
        [disabled]="loading() || facilitiesLoading()"
      />
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn-primary" [disabled]="!canSubmit()">
      @if (loading()) {
      {{ text('BOOKING_PREVIEW.FORM.SUBMIT_CHECKING', 'Checking...') }}
      } @else {
      {{
        text(
          'BOOKING_PREVIEW.FORM.SUBMIT_CHECK_AVAILABILITY',
          'Check Availability'
        )
      }}
      }
    </button>
  </form>

  <!-- Empty State -->
  @if (!loading() && !facilitiesLoading() && !error() && facilities().length ===
  0) {
  <div class="empty-state preview-empty" role="status">
    <p>
      {{
        text('BOOKING_PREVIEW.EMPTY.NO_FACILITIES', 'No facilities available.')
      }}
    </p>
  </div>
  }

  <!-- Error Message -->
  @if (error(); as err) {
  <div
    class="error-message"
    id="booking-preview-error"
    role="alert"
    aria-live="assertive"
  >
    <div class="error-text">
      <strong>{{ errorCategoryLabel() }}</strong>
      <span>{{ err.message }}</span>
      @if (retryCountdown(); as seconds) {
      <div class="retry-info">
        {{ retryCountdownMessage(seconds) }}
      </div>
      }
    </div>
    <div class="error-actions">
      @for (option of errorRecoveryOptions(); track option.action) {
      <button
        type="button"
        class="btn-secondary"
        (click)="handleErrorRecovery(option.action)"
        [attr.aria-label]="option.label"
      >
        {{ option.label }}
      </button>
      }
    </div>
  </div>
  } @if (loading() && !previewResult()) {
  <div class="preview-skeleton" role="status" aria-live="polite">
    <div class="skeleton-line skeleton-title"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line"></div>
    <div class="skeleton-line skeleton-block"></div>
  </div>
  }

  <!-- Preview Result -->
  @if (previewResult(); as result) {
  <div
    class="preview-result"
    [class.success]="result.canBook"
    [class.conflict]="!result.canBook"
    role="region"
    aria-live="polite"
    [attr.aria-label]="
      text('BOOKING_PREVIEW.PAGE.RESULT_REGION_LABEL', 'Booking preview result')
    "
  >
    @if (previewStale() || isPreviewStale()) {
    <div class="stale-banner" role="status" aria-live="polite">
      <span>{{
        text('BOOKING_PREVIEW.STALE.MESSAGE', 'Preview data may be outdated.')
      }}</span>
      <button
        type="button"
        class="btn-secondary"
        (click)="handleErrorRecovery('refresh')"
      >
        {{ text('BOOKING_PREVIEW.STALE.REFRESH', 'Refresh') }}
      </button>
    </div>
    }
    <!-- Status Header -->
    <div class="result-header">
      @if (result.canBook) {
      <span class="status-icon success" aria-hidden="true">✓</span>
      <h2>{{ text('BOOKING_PREVIEW.STATUS.AVAILABLE', 'Available!') }}</h2>
      } @else {
      <span class="status-icon conflict" aria-hidden="true">✗</span>
      <h2>
        {{ text('BOOKING_PREVIEW.STATUS.NOT_AVAILABLE', 'Not Available') }}
      </h2>
      }
    </div>

    <!-- Validation Errors -->
    @if (result.validationErrors && result.validationErrors.length > 0) {
    <div class="validation-errors">
      <h3>
        {{
          text('BOOKING_PREVIEW.VALIDATION.ISSUES_TITLE', 'Validation Issues:')
        }}
      </h3>
      <ul>
        @for (error of result.validationErrors; track error) {
        <li>{{ error }}</li>
        }
      </ul>
    </div>
    }

    <!-- Conflict Info -->
    @if (result.conflict) {
    <div class="conflict-info">
      <p class="conflict-message">{{ result.conflict.message }}</p>
      @if (result.conflict.conflictType) {
      <p class="conflict-type">
        {{ formatConflictType(result.conflict.conflictType) }}
      </p>
      } @if (result.conflict.conflictingSlots.length > 0) {
      <div class="conflicting-slots" role="list">
        <h4>
          {{
            text(
              'BOOKING_PREVIEW.CONFLICT.CONFLICTING_SLOTS_TITLE',
              'Conflicting Slots:'
            )
          }}
        </h4>
        @for (slot of result.conflict.conflictingSlots; track
        trackConflictSlot($index, slot)) {
        <div
          class="slot"
          role="listitem"
          [attr.aria-label]="conflictSlotAriaLabel(slot)"
        >
          <span class="slot-time"
            >{{ formatTime(slot.startTime) }} -
            {{ formatTime(slot.endTime) }}</span
          >
          <app-ui-status-badge
            [tone]="conflictSlotStatusTone(slot.status)"
            [label]="conflictSlotStatusLabel(slot.status)"
          ></app-ui-status-badge>
          @if (slot.bookingReference) {
          <span class="ref">({{ slot.bookingReference }})</span>
          }
        </div>
        }
      </div>
      }
    </div>
    }

    <!-- Price Breakdown -->
    <div class="price-breakdown">
      <h3>{{ text('BOOKING_PREVIEW.PRICING.TITLE', 'Price Breakdown') }}</h3>
      <table
        [attr.aria-label]="
          text('BOOKING_PREVIEW.PRICING.TABLE_ARIA_LABEL', 'Price breakdown')
        "
      >
        <tr>
          <td>
            {{ text('BOOKING_PREVIEW.PRICING.BASE_PRICE', 'Base Price') }}
          </td>
          <td>
            {{
              formatPrice(
                result.priceBreakdown.basePrice,
                result.priceBreakdown.currency
              )
            }}
          </td>
        </tr>
        @if (result.priceBreakdown.timeMultiplier !== 1) {
        <tr>
          <td>
            {{
              text(
                'BOOKING_PREVIEW.PRICING.PEAK_HOURS_RATE',
                'Peak Hours ({{multiplier
            }}x)', { multiplier: result.priceBreakdown.timeMultiplier } ) }}
          </td>
          <td class="modifier">
            {{ text('BOOKING_PREVIEW.PRICING.APPLIED', 'Applied') }}
          </td>
        </tr>
        } @if (result.priceBreakdown.dayMultiplier !== 1) {
        <tr>
          <td>
            {{
              text(
                'BOOKING_PREVIEW.PRICING.WEEKEND_RATE',
                'Weekend Rate ({{multiplier
            }}x)', { multiplier: result.priceBreakdown.dayMultiplier } ) }}
          </td>
          <td class="modifier">
            {{ text('BOOKING_PREVIEW.PRICING.APPLIED', 'Applied') }}
          </td>
        </tr>
        }
        <tr>
          <td>{{ text('BOOKING_PREVIEW.PRICING.SUBTOTAL', 'Subtotal') }}</td>
          <td>
            {{
              formatPrice(
                result.priceBreakdown.subtotal,
                result.priceBreakdown.currency
              )
            }}
          </td>
        </tr>
        @if (result.priceBreakdown.discountAmount > 0) {
        <tr class="discount">
          <td>{{ text('BOOKING_PREVIEW.PRICING.DISCOUNT', 'Discount') }}</td>
          <td>
            -{{
              formatPrice(
                result.priceBreakdown.discountAmount,
                result.priceBreakdown.currency
              )
            }}
          </td>
        </tr>
        } @if (result.priceBreakdown.promoCode) {
        <tr class="promo">
          <td>
            {{
              text(
                'BOOKING_PREVIEW.PRICING.PROMO_CODE',
                'Promo ({{code
            }})', { code: result.priceBreakdown.promoCode } ) }}
          </td>
          <td>
            -{{
              formatPrice(
                result.priceBreakdown.promoDiscount || 0,
                result.priceBreakdown.currency
              )
            }}
          </td>
        </tr>
        }
        <tr class="total">
          <td>
            <strong>{{
              text('BOOKING_PREVIEW.PRICING.TOTAL', 'Total')
            }}</strong>
          </td>
          <td>
            <strong>{{
              formatPrice(
                result.priceBreakdown.total,
                result.priceBreakdown.currency
              )
            }}</strong>
          </td>
        </tr>
      </table>
    </div>

    <!-- Suggested Alternatives -->
    @if (alternativesCount() > 0) {
    <div class="alternatives">
      <div class="alternatives-header">
        <h3>
          {{
            text('BOOKING_PREVIEW.ALTERNATIVES.TITLE', 'Available Alternatives')
          }}
        </h3>
        @if (showAlternativesToggle()) {
        <button
          type="button"
          class="btn-secondary"
          (click)="toggleAlternatives()"
        >
          {{ alternativesToggleLabel() }}
        </button>
        }
      </div>
      @if (showAlternatives()) { @if (shouldVirtualizeAlternatives()) {
      <div
        class="alternatives-scroll"
        role="region"
        [attr.aria-label]="
          text(
            'BOOKING_PREVIEW.ALTERNATIVES.REGION_LABEL',
            'Alternative booking slots'
          )
        "
        (scroll)="onAlternativesScroll($event)"
      >
        <div
          class="alternatives-virtual"
          [style.padding-block-start.px]="alternativesWindow().paddingTop"
          [style.padding-block-end.px]="alternativesWindow().paddingBottom"
          [style.min-block-size.px]="alternativesWindow().totalHeight"
        >
          @for (alt of alternativesWindow().items; track alt.startTime) {
          <button
            class="alt-slot alt-slot--list"
            type="button"
            (click)="selectAlternative(alt)"
            [attr.aria-label]="alternativeSlotAriaLabel(alt)"
          >
            <span class="time"
              >{{ formatTime(alt.startTime) }} -
              {{ formatTime(alt.endTime) }}</span
            >
            <span class="price">{{
              formatPrice(alt.price, alt.currency)
            }}</span>
          </button>
          }
        </div>
      </div>
      } @else {
      <div class="alternatives-grid">
        @for (alt of alternatives(); track alt.startTime) {
        <button
          class="alt-slot"
          type="button"
          (click)="selectAlternative(alt)"
          [attr.aria-label]="alternativeSlotAriaLabel(alt)"
        >
          <span class="time"
            >{{ formatTime(alt.startTime) }} -
            {{ formatTime(alt.endTime) }}</span
          >
          <span class="price">{{ formatPrice(alt.price, alt.currency) }}</span>
        </button>
        }
      </div>
      } } @else {
      <p class="alternatives-hint">
        {{
          text(
            'BOOKING_PREVIEW.ALTERNATIVES.HINT',
            'Tap to view alternative slots.'
          )
        }}
      </p>
      }
    </div>
    }

    <!-- Customer Details (show when available) -->
    @if (result.canBook) {
    <div class="customer-details">
      <h3>{{ text('BOOKING_PREVIEW.CUSTOMER.TITLE', 'Customer Details') }}</h3>
      <div class="form-row">
        <div class="form-group">
          <label for="customerName">{{
            text('BOOKING_PREVIEW.CUSTOMER.NAME_LABEL', 'Your Name')
          }}</label>
          <input
            type="text"
            id="customerName"
            [ngModel]="customerName()"
            (ngModelChange)="customerName.set($event)"
            name="customerName"
            [attr.placeholder]="
              text(
                'BOOKING_PREVIEW.CUSTOMER.NAME_PLACEHOLDER',
                'Enter your full name'
              )
            "
            required
            autocomplete="name"
            [disabled]="bookingInProgress()"
          />
        </div>
        <div class="form-group">
          <label for="customerPhone">{{
            text('BOOKING_PREVIEW.CUSTOMER.PHONE_LABEL', 'Phone Number')
          }}</label>
          <input
            type="tel"
            id="customerPhone"
            [ngModel]="customerPhone()"
            (ngModelChange)="customerPhone.set($event)"
            name="customerPhone"
            [attr.placeholder]="
              text(
                'BOOKING_PREVIEW.CUSTOMER.PHONE_PLACEHOLDER',
                '+966 5XX XXX XXXX'
              )
            "
            required
            autocomplete="tel"
            inputmode="tel"
            [disabled]="bookingInProgress()"
          />
        </div>
      </div>
      <div class="hold-toggle">
        <label for="holdAsPending">
          <input
            type="checkbox"
            [ngModel]="holdAsPending()"
            (ngModelChange)="holdAsPending.set($event)"
            name="holdAsPending"
            id="holdAsPending"
            aria-describedby="hold-hint"
            [disabled]="bookingInProgress()"
          />
          {{
            text(
              'BOOKING_PREVIEW.CUSTOMER.HOLD_LABEL',
              'Reserve as hold (pending)'
            )
          }}
        </label>
        <p class="hold-hint" id="hold-hint">
          {{
            text(
              'BOOKING_PREVIEW.CUSTOMER.HOLD_HINT',
              'Temporarily reserve this slot until confirmation.'
            )
          }}
        </p>
      </div>
    </div>

    <!-- Confirm Booking Button -->
    <button
      type="button"
      class="btn-book"
      [disabled]="!canBook()"
      (click)="openConfirmDialog()"
    >
      @if (bookingInProgress()) {
      {{ text('BOOKING_PREVIEW.ACTIONS.CONFIRMING', 'Confirming...') }}
      } @else {
      {{ text('BOOKING_PREVIEW.ACTIONS.CONFIRM_BOOKING', 'Confirm Booking') }}
      }
    </button>
    }
  </div>
  } @if (confirmDialogOpen() && previewResult(); as result) { @let facility =
  selectedFacility();
  <app-confirmation-dialog
    [title]="confirmCopy.title"
    [message]="confirmCopy.message"
    [confirmLabel]="confirmCopy.confirmLabel"
    [cancelLabel]="confirmCopy.cancelLabel"
    [confirmTone]="'primary'"
    [confirmDisabled]="!canBook()"
    [busy]="bookingInProgress()"
    (confirmed)="onBook()"
    (dismissed)="closeConfirmDialog()"
  >
    <div class="confirm-summary">
      <div class="confirm-row">
        <span class="label">{{
          text('BOOKING_PREVIEW.CONFIRM_SUMMARY.FACILITY_LABEL', 'Facility')
        }}</span>
        <span class="value">{{
          facility?.name ??
            text(
              'BOOKING_PREVIEW.CONFIRM_SUMMARY.SELECTED_FACILITY_FALLBACK',
              'Selected facility'
            )
        }}</span>
      </div>
      <div class="confirm-row">
        <span class="label">{{
          text('BOOKING_PREVIEW.CONFIRM_SUMMARY.DATE_LABEL', 'Date')
        }}</span>
        <span class="value">{{ selectedDate() }}</span>
      </div>
      <div class="confirm-row">
        <span class="label">{{
          text('BOOKING_PREVIEW.CONFIRM_SUMMARY.TIME_LABEL', 'Time')
        }}</span>
        <span class="value">
          {{ formatTime(selectedDate() + 'T' + startTime()) }} -
          {{ formatTime(selectedDate() + 'T' + endTime()) }}
        </span>
      </div>
      <div class="confirm-row">
        <span class="label">{{
          text('BOOKING_PREVIEW.CONFIRM_SUMMARY.TOTAL_LABEL', 'Total')
        }}</span>
        <span class="value">{{
          formatPrice(
            result.priceBreakdown.total,
            result.priceBreakdown.currency
          )
        }}</span>
      </div>
      @if (holdAsPending()) {
      <div class="confirm-row">
        <span class="label">{{
          text('BOOKING_PREVIEW.CONFIRM_SUMMARY.HOLD_LABEL', 'Hold')
        }}</span>
        <span class="value">{{
          text(
            'BOOKING_PREVIEW.CONFIRM_SUMMARY.HOLD_PENDING_VALUE',
            'Reserve as pending'
          )
        }}</span>
      </div>
      }
    </div>
    <p class="policy-note">{{ cancellationPolicyNote }}</p>
  </app-confirmation-dialog>
  }

  <!-- Booking Success Message -->
  @if (bookingSuccess()) {
  <div class="success-message" role="status" aria-live="polite">
    <span class="success-icon" aria-hidden="true">✓</span>
    <p>{{ text('BOOKING_PREVIEW.SUCCESS.TITLE', 'Booking Confirmed!') }}</p>
    @if (bookingReference()) {
    <p class="success-reference">
      {{ text('BOOKING_PREVIEW.SUCCESS.REFERENCE_PREFIX', 'Reference:') }}
      {{ bookingReference() }}
    </p>
    }
    <p class="success-subtitle">
      {{
        text(
          'BOOKING_PREVIEW.SUCCESS.SUBTITLE',
          'You will receive a confirmation shortly.'
        )
      }}
    </p>
    <button type="button" class="btn-secondary" (click)="resetBooking()">
      {{ text('BOOKING_PREVIEW.SUCCESS.CTA_ANOTHER', 'Make Another Booking') }}
    </button>
  </div>
  }
</main>
